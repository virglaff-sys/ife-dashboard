<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <title>IFE Roadmap | Редактор задач</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: #fff; color: #000; font-weight: 300; line-height: 1.5;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 30px; }
        .header {
            border-bottom: 1px solid #e0e0e0; padding: 15px 0;
            position: sticky; top: 0; background: #fff; z-index: 1000;
        }
        .header-container { display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 12px; text-decoration: none; color: #000; }
        .logo-text { font-size: 1.4rem; }
        .nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .nav a, .nav button {
            text-decoration: none; color: #000; padding: 10px 20px; border: 1px solid transparent;
            font-size: 0.9rem; background: none; cursor: pointer;
            border-radius: 4px;
        }
        .nav a:hover, .nav a.active, .nav button:hover { border-color: #e0e0e0; background: #f9f9f9; }
        .nav button { font-family: inherit; }

        /* Зелёная кнопка Сохранить */
        .save-btn {
            background-color: #28a745 !important;
            color: white !important;
            border: 1px solid #28a745 !important;
        }
        .save-btn:hover {
            background-color: #218838 !important;
            border-color: #1e7e34 !important;
        }

        /* Секции */
        .aircraft-section { margin-bottom: 70px; scroll-margin-top: 80px; }
        .section-header {
            display: flex; align-items: baseline; gap: 20px;
            border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;
        }
        .section-title { font-size: 2rem; font-weight: 300; }

        /* Подгруппа (тип ВС) */
        .subgroup { margin-bottom: 50px; }
        .subgroup-header {
            font-size: 1.5rem; font-weight: 300; padding: 10px 0 10px 10px;
            border-left: 4px solid #000; margin: 30px 0 20px;
            cursor: pointer; user-select: none; display: flex; align-items: center; gap: 10px;
        }
        .subgroup-header i { transition: transform 0.2s; }
        .subgroup.collapsed .subgroup-header i { transform: rotate(-90deg); }
        .subgroup-content { overflow: hidden; transition: max-height 0.3s; }
        .subgroup.collapsed .subgroup-content { display: none; }

        /* Колонки */
        .task-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }

        .task-block {
            border: 1px solid #e0e0e0;
        }
        .task-block.contract { border-top: 4px solid #1e3a5f; }
        .task-block.new { border-top: 4px solid #b85e00; background-color: #fff8e7; }

        .column-header {
            padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 1px solid #e0e0e0; user-select: none;
        }
        .column-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .column-header-left h3 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }
        .column-header i { transition: transform 0.2s; }
        .task-block.active .column-header i.chevron { transform: rotate(90deg); }
        .column-content { padding: 20px; display: none; }
        .task-block.active .column-content { display: block; }

        /* Аккордеоны внутри колонок */
        .accordion-item {
            margin-bottom: 12px;
            margin-top: 20px; /* отступ между группами */
        }
        .accordion-header {
            background: #f2f2f2; padding: 10px 15px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #e0e0e0; user-select: none;
        }
        .accordion-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .accordion-header-left span {
            font-weight: 500;
        }
        .accordion-header i { transition: transform 0.2s; }
        .accordion-content {
            padding: 15px 20px; border: 1px solid #e0e0e0; border-top: none;
            background: #fff; display: none;
        }
        .accordion-item.active .accordion-content { display: block; }
        .accordion-item.active .accordion-header i.chevron { transform: rotate(90deg); }

        /* Кнопки действий над заголовками */
        .edit-icon, .delete-icon, .add-section-icon {
            color: #999;
            cursor: pointer;
            font-size: 0.9rem;
            transition: color 0.2s;
        }
        .edit-icon:hover { color: #007bff; }
        .delete-icon:hover { color: #c00; }
        .add-section-icon:hover { color: #28a745; }

        /* Списки задач */
        .task-list {
            list-style: none;
            min-height: 30px;
            margin-top: 10px;
        }
        .task-list li {
            padding: 8px 10px 8px 8px;
            border-bottom: 1px dashed #e0e0e0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            background: #fff;
            cursor: grab;
            flex-wrap: wrap;
        }
        .task-list li:last-child { border-bottom: none; }
        .task-list li i:first-child { width: 20px; }
        .fa-file-signature { color: #1e3a5f; }
        .fa-bolt { color: #b85e00; }

        /* Контейнер для иконок действий, чтобы прижать их вправо */
        .task-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        /* Кнопки действий (галочка, минус, корзина) */
        .mark-hight, .mark-low, .delete-task {
            color: #999;
            cursor: pointer;
            font-size: 0.9rem;
            transition: color 0.2s;
        }
        .mark-hight:hover { color: #28a745; }
        .mark-low:hover { color: #dc3545; }
        .delete-task:hover { color: #c00; }

        /* Метки hight и low */
        .hight-label, .low-label {
            font-size: 0.7rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 12px;
            margin-left: 8px;
            text-transform: uppercase;
            display: inline-block;
            color: white;
        }
        .hight-label {
            background-color: #28a745;
        }
        .low-label {
            background-color: #dc3545;
        }

        /* Форма добавления новой задачи (теперь сверху) */
        .add-task-form {
            display: flex;
            margin-bottom: 12px;
            gap: 6px;
        }
        .add-task-form input {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #e0e0e0;
            font-size: 0.9rem;
            border-radius: 4px;
        }
        .add-task-form button {
            background: #f0f0f0;
            border: 1px solid #e0e0e0;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            white-space: nowrap;
            border-radius: 4px;
        }
        .add-task-form button:hover {
            background: #e0e0e0;
        }

        .footer {
            background: #f9f9f9; border-top: 1px solid #e0e0e0;
            padding: 40px 0 20px; margin-top: 60px;
        }
        .copyright { text-align: center; color: #666; font-size: 0.8rem; }
        .reset-btn {
            background: none; border: 1px solid #ccc; padding: 5px 12px;
            cursor: pointer; font-size: 0.8rem; border-radius: 4px;
            margin-left: 5px;
        }
        .reset-btn:hover { background: #f0f0f0; }
        @media (max-width: 900px) { .task-columns { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
<header class="header">
    <div class="container header-container">
        <a href="#" class="logo"><i class="fas fa-tasks"></i><span class="logo-text">IFE ROADMAP</span></a>
        <nav class="nav">
            <a href="#uf">Узкий фюзеляж</a>
            <a href="#shf">Широкий фюзеляж</a>
            <a href="#tablet">Tablet</a>
            <button class="save-btn" id="saveBtn"><i class="fas fa-save"></i> Сохранить</button>
            <button class="reset-btn" id="resetBtn"><i class="fas fa-undo"></i> Сбросить</button>
        </nav>
    </div>
</header>
<main class="container" id="app"></main>
<footer class="footer"><div class="container"><div class="copyright">© 2026 IFE Roadmap. Редактор с сохранением в localStorage и экспортом HTML.</div></div></footer>

<script>
    (function() {
        // ===СКРИПТ_НАЧАЛО===
        // ---------- ИСХОДНЫЕ ДАННЫЕ ----------
        const tasks = {
            A320CEO: {
                contract: {
                    main: [
                        "Апгрейд места (юридические ограничения)",
                        "Обновление контента через GSM модем",
                        "Обновление рекламных материалов через GSM",
                        "Составление плей-листов",
                        "Ограничение контента по возрасту",
                        "Опросы (нет модема) – контракт",
                        "Свежая пресса (нет модема) – контракт",
                        "«Аэрофлот Бонус» (нет модема) – контракт",
                        "Информация о погоде в пункте прилёта (после модемов)",
                        "Добавление модуля Аэрофлот Бонус (после модемов)",
                        "Опросник (после модемов)",
                        "Раздел Свежая пресса (после модемов)",
                        "Добавление Бортового журнала"
                    ],
                    techDebt: [
                        "Бортовое меню: заказ блюд (техдолг)",
                        "Перемотка медиаконтента (шаг 30 сек) (техдолг)",
                        "Протоколирование событий (метрики) (техдолг)",
                        "Анализ логов с борта (требования) (техдолг)",
                        "Магазин на борту (заказ) для стрима (техдолг)",
                        "Магазин на борту (заказ) для встройки (техдолг)"
                    ],
                    statistics: [
                        "Отчётность о работоспособности системы",
                        "Просмотр исторических данных (12 мес.)",
                        "Выгрузка данных о работоспособности",
                        "Просмотр статистики использования контента (12 мес.)",
                        "Выгрузка статистических отчётов",
                        "Статистика авторизации и просмотра контента",
                        "Просмотр рекламы (статистика)",
                        "Статистика эксплуатации компонентов"
                    ],
                    flightScript: [
                        "Открытие полета",
                        "Все двери закрыты + таймер на 5 мин",
                        "Шасси коснулись земли + таймер на 1 минуту",
                        "Дверь открыта + таймер на 10 мин",
                        "Автоматическое закрытие рейса после завершения полета"
                    ]
                },
                panasonic: {
                    general: [
                        "Информация о названии ВС",
                        "Добавление электронных книг (epub)",
                        "Обновление по LTE (основное)",
                        "Заставка и переход в спящий режим",
                        "Проигрывание PRAM (аудио) и PRVM (видео) сообщений",
                        "Поиск контента (кит/рус) — доработка"
                    ],
                    panasonicFunctions: [
                        "Воспроизведение трейлеров на странице контента",
                        "Воспроизведение HD ready video",
                        "Обновление по LTE (специальное)",
                        "Видео с защитой DRM (доработка)"
                    ],
                    advertising: [
                        "Перетяжка на главной странице",
                        "Брендированный канал с контентом",
                        "Карусель с рекламными баннерами",
                        "Режиссирование рекламных роликов",
                        "Проигрывание рекламного ролика после Captive page",
                        "Фиксированное положение рекламного баннера",
                        "Рекламный ролик после закрытия дверей",
                        "Рекламный ролик после посадки"
                    ]
                }
            },
            A320NEO: {
                contract: {
                    main: [
                        "Опросы (нет модема)",
                        "Свежая пресса (нет модема)",
                        "«Аэрофлот Бонус» (нет модема)",
                        "Бортовой журнал (не используется)",
                        "Апгрейд места (юридические ограничения)",
                        "Составление плей-листов",
                        "Ограничение контента по возрасту",
                        "Отчётность о работоспособности (ограничена)",
                        "Получение статуса работоспособности (частично)",
                        "Передача статистики (ограничена)",
                        "Информация о погоде в пункте прилёта (после модемов)",
                        "Добавление модуля Аэрофлот Бонус (после модемов)",
                        "Опросник (после модемов)",
                        "Раздел Свежая пресса (после модемов)",
                        "Добавление Бортового журнала"
                    ],
                    techDebt: [
                        "Бортовое меню: заказ блюд (техдолг)",
                        "Перемотка медиаконтента (шаг 30 сек) (техдолг)",
                        "Протоколирование событий (метрики) (техдолг)",
                        "Анализ логов с борта (требования) (техдолг)",
                        "Магазин на борту (заказ) для стрима (техдолг)",
                        "Магазин на борту (заказ) для встройки (техдолг)"
                    ],
                    statistics: [
                        "Просмотр исторических данных (12 мес.)",
                        "Выгрузка данных о работоспособности",
                        "Просмотр статистики использования контента (12 мес.)",
                        "Выгрузка статистических отчётов",
                        "Статистика авторизации и просмотра контента",
                        "Просмотр рекламы (статистика)",
                        "Статистика эксплуатации компонентов"
                    ],
                    flightScript: [
                        "Открытие полета",
                        "Все двери закрыты + таймер 5 мин",
                        "Шасси коснулись земли + таймер 1 мин",
                        "Дверь открыта + таймер 10 мин",
                        "Автоматическое закрытие рейса"
                    ]
                },
                panasonic: {
                    general: [
                        "Информация о названии ВС",
                        "Добавление электронных книг (epub)",
                        "Отправка текстовых сообщений с CT на монитор",
                        "Кодирование фильмов в M4",
                        "Заставка и переход в спящий режим",
                        "Проигрывание PRAM/PRVM сообщений",
                        "Поиск контента (кит/рус) — доработка"
                    ],
                    panasonicFunctions: [
                        "Воспроизведение трейлеров",
                        "Воспроизведение HD ready video",
                        "Обновление по LTE",
                        "Видео с защитой DRM (доработка)"
                    ],
                    advertising: [
                        "Перетяжка на главной странице",
                        "Брендированный канал с контентом",
                        "Фиксированное положение рекламного баннера",
                        "Карусель с рекламными баннерами",
                        "Режиссирование рекламных роликов",
                        "Проигрывание рекламы после Captive page",
                        "Рекламный ролик (fs после закрытия дверей)",
                        "Рекламный ролик (fs после посадки)"
                    ]
                }
            },
            B737: {
                contract: {
                    main: [
                        "Опросы (нет модема)",
                        "Свежая пресса (нет модема)",
                        "«Аэрофлот Бонус» (нет модема)",
                        "Бортовой журнал (не используется)",
                        "Апгрейд места (юридические ограничения)",
                        "Магазин на борту: заказ товаров (до замены мониторов)",
                        "Составление плей-листов",
                        "Ограничение контента по возрасту",
                        "Получение статуса работоспособности (частично)",
                        "Передача статистики (ограничена)",
                        "Информация о погоде в пункте прилёта (после модемов)",
                        "Добавление модуля Аэрофлот Бонус (после модемов)",
                        "Опросник (после модемов)",
                        "Раздел Свежая пресса (после модемов)",
                        "Добавление Бортового журнала"
                    ],
                    techDebt: [
                        "Бортовое меню: заказ блюд (техдолг)",
                        "Перемотка медиаконтента (шаг 30 сек) (техдолг)",
                        "Протоколирование событий (метрики) (техдолг)",
                        "Анализ логов с борта (требования) (техдолг)",
                        "Магазин на борту (заказ) для стрима (техдолг)",
                        "Магазин на борту (заказ) для встройки (техдолг) (после замены мониторов)"
                    ],
                    statistics: [
                        "Просмотр исторических данных (12 мес.)",
                        "Выгрузка данных о работоспособности",
                        "Просмотр статистики использования контента (12 мес.)",
                        "Выгрузка статистических отчётов",
                        "Статистика авторизации и просмотра контента",
                        "Просмотр рекламы (статистика)",
                        "Статистика эксплуатации компонентов"
                    ],
                    flightScript: [
                        "Открытие полета",
                        "BC Seat Back Monitor: Display Logo, seat number",
                        "Все двери закрыты + таймер 5 мин",
                        "BC Seat Back Monitor: Play Safety VPA",
                        "Шасси коснулись земли + таймер 1 мин",
                        "BC Seat Back Monitor: Play Thank You VPA",
                        "Дверь открыта + таймер 10 мин",
                        "BC Seat Back Monitor: Monitor Backlights off",
                        "Автоматическое закрытие рейса"
                    ]
                },
                panasonic: {
                    general: [
                        "Информация о названии ВС",
                        "Добавление электронных книг (epub)",
                        "Кодирование фильмов в M4",
                        "Заставка и переход в спящий режим",
                        "Проигрывание PRAM/PRVM сообщений",
                        "Поиск контента (кит/рус)"
                    ],
                    panasonicFunctions: [
                        "Воспроизведение трейлеров",
                        "Воспроизведение HD ready video",
                        "Обновление по LTE",
                        "Видео с защитой DRM"
                    ],
                    advertising: [
                        "Перетяжка на главной странице",
                        "Брендированный канал с контентом",
                        "Фиксированное положение рекламного баннера",
                        "Карусель с рекламными баннерами",
                        "Режиссирование рекламных роликов",
                        "Проигрывание рекламы после Captive page",
                        "Рекламный ролик (fs после закрытия дверей)",
                        "Рекламный ролик (fs после посадки)"
                    ]
                }
            },
            A350_B777: {
                contract: {
                    main: [
                        "Свежая пресса (нет модема)",
                        "«Аэрофлот Бонус» (нет модема)",
                        "Опросы (нет модема)",
                        "Информация о полёте (аэропорты, погода, карта)",
                        "Внешнее видео (с камер)",
                        "Выбор места (юридические ограничения)",
                        "Стриминг для пассажиров (аппаратные ограничения)",
                        "Составление плей-листов",
                        "Информация о погоде в пункте прилёта (после модемов)",
                        "Добавление модуля Аэрофлот Бонус (после модемов)",
                        "Опросник (после модемов)",
                        "Раздел Свежая пресса (после модемов)",
                        "Добавление Бортового журнала"
                    ],
                    techDebt: [
                        "Бортовое меню: заказ блюд (техдолг)",
                        "Перемотка и пропуск рекламы (нет отключения) (техдолг)",
                        "Перемотка медиаконтента (шаг 30 сек) (техдолг)",
                        "Поиск контента (только англ., не по языковым дорожкам) (техдолг)",
                        "Виртуальная клавиатура (только англ.) (техдолг)"
                    ],
                    statistics: [
                        "Просмотр исторических данных (12 мес.)",
                        "Выгрузка данных о работоспособности",
                        "Просмотр статистики использования контента (12 мес.)",
                        "Выгрузка статистических отчётов",
                        "Статистика авторизации и просмотра контента",
                        "Просмотр рекламы (статистика)",
                        "Статистика эксплуатации компонентов"
                    ],
                    flightScript: [
                        "Открытие полета",
                        "BC Seat Back Monitor: Display Logo, seat number",
                        "BC VHS: Display Logo, seat number",
                        "EC Seat Back Monitor: Display Logo, seat number",
                        "Wall Monitors: Play Welcome Overhead",
                        "Все двери закрыты + таймер 5 мин",
                        "BC Seat Back Monitor: Play Safety VPA, Corp Video 1, Display CMI, Corp Video 2, реклама, Camera Message",
                        "BC VHS: Play VPA, сообщения",
                        "EC Seat Back Monitor: Play Safety VPA, Corp Video 1, Corp Video 2, CMI, реклама, Camera Message",
                        "Wall Monitors: Play Safety VPA, Corp Video 1, Corp Video 2, реклама, Show camera",
                        "Шасси коснулись земли + таймер 1 мин",
                        "BC Seat Back Monitor: Play Thank You VPA",
                        "BC VHS: Play VPA",
                        "EC Seat Back Monitor: Play Thank You VPA",
                        "Wall Monitors: Play Thank You VPA",
                        "Дверь открыта + таймер 10 мин",
                        "BC Seat Back Monitor: Monitor Backlights off",
                        "BC VHS: Monitor Backlights off",
                        "EC Seat Back Monitor: Monitor Backlights off",
                        "Wall Monitors: Monitor Backlights off",
                        "Автоматическое закрытие рейса"
                    ]
                },
                panasonic: {
                    general: [
                        "Информация о названии ВС",
                        "Добавление электронных книг (epub)",
                        "Трейлеры (общие)",
                        "Обновление стиками (реклама/контент) (общее)",
                        "Заставка и переход в спящий режим",
                        "Проигрывание PRAM/PRVM сообщений",
                        "Стриминг на ШФ (для пассажиров) — проработка"
                    ],
                    panasonicFunctions: [
                        "Воспроизведение трейлеров (спец.)",
                        "Воспроизведение HD ready video",
                        "Обновление стиками (реклама/контент) (спец.)",
                        "Видео с защитой DRM (доработка)"
                    ],
                    advertising: [
                        "Перетяжка на главной странице",
                        "Брендированный канал с контентом",
                        "Фиксированное положение рекламного баннера",
                        "Карусель с рекламными баннерами",
                        "Режиссирование рекламных роликов",
                        "Проигрывание рекламы после Captive page"
                    ]
                }
            },
            Tablet: {
                contract: null,
                panasonic: {
                    general: [
                        "Пресса в PDF",
                        "Блокировка скриншотов",
                        "DRM контент",
                        "Добавление Бортового журнала",
                        "Добавление электронных книг (epub)",
                        "Модуль Магазин на борту (заказ)",
                        "Добавление модуля Меню (заказ)",
                        "Трейлеры",
                        "Воспроизведение аудио в фоновом режиме",
                        "Опросник",
                        "Изменение дизайна главной страницы",
                        "Добавление модуля Аэрофлот Бонус",
                        "Модуль Вызовы",
                        "Welcome-видео",
                        "Рейтинг Кинопоиск + награды"
                    ],
                    panasonicFunctions: [],
                    advertising: [
                        "Брендированный канал с контентом",
                        "Фиксированное положение рекламного баннера",
                        "Режиссирование рекламных роликов",
                        "Добавление рекламных баннеров на главную (карусель)"
                    ]
                }
            }
        };

        // ---------- ФУНКЦИИ ПОСТРОЕНИЯ DOM ----------
        function renderAccordion(title, items, iconClass) {
            if (!items || items.length === 0) items = [];
            return `
                <div class="accordion-item active">
                    <div class="accordion-header">
                        <div class="accordion-header-left">
                            <i class="fas ${iconClass}"></i>
                            <span>${title}</span>
                            <i class="fas fa-pencil-alt edit-icon"></i>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <i class="fas fa-trash delete-icon"></i>
                            <i class="fas fa-chevron-right chevron"></i>
                        </div>
                    </div>
                    <div class="accordion-content">
                        <div class="add-task-form">
                            <input type="text" placeholder="Новая задача...">
                            <button type="button">Добавить</button>
                        </div>
                        <ul class="task-list" data-type="accordion">
                            ${items.map(i => `<li><i class="fas ${iconClass}"></i> ${i} <span class="task-actions"><i class="fas fa-circle-check mark-hight"></i><i class="fas fa-circle-minus mark-low"></i><i class="fas fa-trash delete-task"></i></span></li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
        }

        function renderColumn(data, type) {
            if (!data) return '<div class="task-block"><div class="column-header">Нет задач</div></div>';
            const isContract = type === 'contract';
            const blockClass = isContract ? 'contract' : 'new';
            const icon = isContract ? 'fa-file-signature' : 'fa-bolt';
            const defaultTitle = isContract ? 'Обязательства по договору на ПО' : 'Новый функционал';

            let innerHtml = '';

            if (isContract) {
                // Левая колонка
                if (data.main && data.main.length) {
                    innerHtml += `
                        <div class="add-task-form">
                            <input type="text" placeholder="Новая задача...">
                            <button type="button">Добавить</button>
                        </div>
                        <ul class="task-list" data-type="main">
                            ${data.main.map(i => `<li><i class="fas fa-file-signature"></i> ${i} <span class="task-actions"><i class="fas fa-circle-check mark-hight"></i><i class="fas fa-circle-minus mark-low"></i><i class="fas fa-trash delete-task"></i></span></li>`).join('')}
                        </ul>
                    `;
                }
                if (data.techDebt && data.techDebt.length) {
                    innerHtml += renderAccordion('Функции с техдолгом', data.techDebt, 'fa-file-signature');
                }
                if (data.statistics && data.statistics.length) {
                    innerHtml += renderAccordion('Статистика', data.statistics, 'fa-file-signature');
                }
                if (data.flightScript && data.flightScript.length) {
                    innerHtml += renderAccordion('flight script', data.flightScript, 'fa-file-signature');
                }
            } else {
                // Правая колонка
                if (data.general && data.general.length) {
                    innerHtml += `
                        <div class="add-task-form">
                            <input type="text" placeholder="Новая задача...">
                            <button type="button">Добавить</button>
                        </div>
                        <ul class="task-list" data-type="general">
                            ${data.general.map(i => `<li><i class="fas fa-bolt"></i> ${i} <span class="task-actions"><i class="fas fa-circle-check mark-hight"></i><i class="fas fa-circle-minus mark-low"></i><i class="fas fa-trash delete-task"></i></span></li>`).join('')}
                        </ul>
                    `;
                }
                if (data.panasonicFunctions && data.panasonicFunctions.length) {
                    innerHtml += renderAccordion('Функции Panasonic', data.panasonicFunctions, 'fa-bolt');
                }
                if (data.advertising && data.advertising.length) {
                    innerHtml += renderAccordion('Рекламные возможности', data.advertising, 'fa-bolt');
                }
            }

            return `
                <div class="task-block ${blockClass} active">
                    <div class="column-header">
                        <div class="column-header-left">
                            <i class="fas ${icon}"></i>
                            <h3>${defaultTitle}</h3>
                            <i class="fas fa-pencil-alt edit-icon"></i>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <i class="fas fa-plus add-section-icon"></i>
                            <i class="fas fa-chevron-right chevron"></i>
                        </div>
                    </div>
                    <div class="column-content">
                        ${innerHtml}
                    </div>
                </div>
            `;
        }

        function renderSubgroup(title, data) {
            return `
                <div class="subgroup">
                    <div class="subgroup-header">
                        <i class="fas fa-chevron-down"></i> ${title}
                    </div>
                    <div class="subgroup-content">
                        <div class="task-columns">
                            ${renderColumn(data.contract, 'contract')}
                            ${renderColumn(data.panasonic, 'new')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Сборка всего приложения
        function buildApp() {
            return `
                <!-- Узкий фюзеляж -->
                <section id="uf" class="aircraft-section">
                    <div class="section-header"><h2 class="section-title">Узкий фюзеляж (УФ)</h2><span class="section-tag">A320CEO, A320NEO, B737</span></div>
                    ${renderSubgroup('A320 CEO', { contract: tasks.A320CEO.contract, panasonic: tasks.A320CEO.panasonic })}
                    ${renderSubgroup('A320 NEO', { contract: tasks.A320NEO.contract, panasonic: tasks.A320NEO.panasonic })}
                    ${renderSubgroup('B737', { contract: tasks.B737.contract, panasonic: tasks.B737.panasonic })}
                </section>
                <!-- Широкий фюзеляж -->
                <section id="shf" class="aircraft-section">
                    <div class="section-header"><h2 class="section-title">Широкий фюзеляж (ШФ)</h2><span class="section-tag">A350, B777</span></div>
                    ${renderSubgroup('A350 / B777', { contract: tasks.A350_B777.contract, panasonic: tasks.A350_B777.panasonic })}
                </section>
                <!-- Tablet -->
                <section id="tablet" class="aircraft-section">
                    <div class="section-header"><h2 class="section-title">Tablet (планшеты бортпроводников)</h2><span class="section-tag">Отдельное оборудование</span></div>
                    ${renderSubgroup('Tablet', { contract: tasks.Tablet.contract, panasonic: tasks.Tablet.panasonic })}
                </section>
            `;
        }

        // ---------- РАБОТА С LOCALSTORAGE ----------
        const STORAGE_KEY = 'ifeRoadmap';

        function saveToLocalStorage() {
            const subgroupContents = [];
            document.querySelectorAll('.subgroup-content').forEach(el => {
                subgroupContents.push(el.innerHTML);
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(subgroupContents));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return false;
            try {
                const contents = JSON.parse(saved);
                const targets = document.querySelectorAll('.subgroup-content');
                if (contents.length !== targets.length) return false;
                targets.forEach((el, idx) => {
                    el.innerHTML = contents[idx];
                });
                return true;
            } catch (e) {
                return false;
            }
        }

        // ---------- ИНИЦИАЛИЗАЦИЯ SORTABLE ----------
        let sortableInstances = [];

        function initSortable() {
            sortableInstances.forEach(s => s.destroy());
            sortableInstances = [];

            document.querySelectorAll('.task-list').forEach(list => {
                const sortable = Sortable.create(list, {
                    group: 'tasks',
                    animation: 150,
                    handle: 'li',
                    draggable: 'li',
                    onEnd: function() {
                        saveToLocalStorage();
                    }
                });
                sortableInstances.push(sortable);
            });
        }

        // ---------- ОБРАБОТЧИКИ ----------
        function toggleHight(li) {
            let label = li.querySelector('.hight-label');
            if (label) {
                label.remove();
            } else {
                label = document.createElement('span');
                label.className = 'hight-label';
                label.textContent = 'hight';
                const actions = li.querySelector('.task-actions');
                if (actions) {
                    li.insertBefore(label, actions);
                } else {
                    li.appendChild(label);
                }
            }
            saveToLocalStorage();
        }

        function toggleLow(li) {
            let label = li.querySelector('.low-label');
            if (label) {
                label.remove();
            } else {
                label = document.createElement('span');
                label.className = 'low-label';
                label.textContent = 'low';
                const actions = li.querySelector('.task-actions');
                if (actions) {
                    li.insertBefore(label, actions);
                } else {
                    li.appendChild(label);
                }
            }
            saveToLocalStorage();
        }

        function handleDelete(li) {
            li.remove();
            saveToLocalStorage();
        }

        function handleAdd(input, button, list) {
            const text = input.value.trim();
            if (!text) return;
            const taskBlock = list.closest('.task-block');
            const iconClass = taskBlock.classList.contains('contract') ? 'fa-file-signature' : 'fa-bolt';
            const newLi = document.createElement('li');
            newLi.innerHTML = `<i class="fas ${iconClass}"></i> ${text} <span class="task-actions"><i class="fas fa-circle-check mark-hight"></i><i class="fas fa-circle-minus mark-low"></i><i class="fas fa-trash delete-task"></i></span>`;
            list.appendChild(newLi);
            input.value = '';
            saveToLocalStorage();
        }

        // Редактирование заголовка (колонки или аккордеона)
        function handleEditTitle(target) {
            // Определяем, что редактируем: заголовок колонки или аккордеона
            const columnHeader = target.closest('.column-header');
            if (columnHeader) {
                const titleSpan = columnHeader.querySelector('h3');
                if (!titleSpan) return;
                const oldTitle = titleSpan.textContent;
                const newTitle = prompt('Введите новое название раздела:', oldTitle);
                if (newTitle && newTitle.trim() !== '') {
                    titleSpan.textContent = newTitle.trim();
                    saveToLocalStorage();
                }
                return;
            }

            const accordionHeader = target.closest('.accordion-header');
            if (accordionHeader) {
                const titleSpan = accordionHeader.querySelector('.accordion-header-left span');
                if (!titleSpan) return;
                const oldTitle = titleSpan.textContent;
                const newTitle = prompt('Введите новое название раздела:', oldTitle);
                if (newTitle && newTitle.trim() !== '') {
                    titleSpan.textContent = newTitle.trim();
                    saveToLocalStorage();
                }
                return;
            }
        }

        // Удаление аккордеона
        function handleDeleteAccordion(accordionItem) {
            accordionItem.remove();
            saveToLocalStorage();
            // Пересоздаём Sortable, т.к. удалились списки
            initSortable();
        }

        // Добавление нового раздела (аккордеона) в колонку
        function handleAddSection(columnContent, iconClass) {
            const newAccordion = document.createElement('div');
            newAccordion.className = 'accordion-item active';
            newAccordion.innerHTML = `
                <div class="accordion-header">
                    <div class="accordion-header-left">
                        <i class="fas ${iconClass}"></i>
                        <span>Новый раздел</span>
                        <i class="fas fa-pencil-alt edit-icon"></i>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <i class="fas fa-trash delete-icon"></i>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="add-task-form">
                        <input type="text" placeholder="Новая задача...">
                        <button type="button">Добавить</button>
                    </div>
                    <ul class="task-list" data-type="accordion">
                        <!-- пустой список -->
                    </ul>
                </div>
            `;
            columnContent.appendChild(newAccordion);
            saveToLocalStorage();
            // Обновляем Sortable, чтобы новый список стал перетаскиваемым
            initSortable();
        }

        // Глобальный обработчик кликов
        document.addEventListener('click', function(e) {
            // Сворачивание подгрупп
            const subgroupHeader = e.target.closest('.subgroup-header');
            if (subgroupHeader) {
                e.preventDefault();
                const subgroup = subgroupHeader.closest('.subgroup');
                if (subgroup) subgroup.classList.toggle('collapsed');
                return;
            }

            // Сворачивание колонок
            const columnHeader = e.target.closest('.column-header');
            if (columnHeader && !e.target.closest('.edit-icon') && !e.target.closest('.add-section-icon')) {
                e.preventDefault();
                const taskBlock = columnHeader.closest('.task-block');
                if (taskBlock) taskBlock.classList.toggle('active');
                return;
            }

            // Сворачивание аккордеонов
            const accordionHeader = e.target.closest('.accordion-header');
            if (accordionHeader && !e.target.closest('.edit-icon') && !e.target.closest('.delete-icon')) {
                e.preventDefault();
                const accordionItem = accordionHeader.closest('.accordion-item');
                if (accordionItem) accordionItem.classList.toggle('active');
                return;
            }

            // Редактирование заголовка (карандаш)
            if (e.target.closest('.edit-icon')) {
                e.preventDefault();
                handleEditTitle(e.target);
                return;
            }

            // Удаление аккордеона (корзина в заголовке аккордеона)
            if (e.target.closest('.delete-icon')) {
                e.preventDefault();
                const accordionItem = e.target.closest('.accordion-item');
                if (accordionItem) handleDeleteAccordion(accordionItem);
                return;
            }

            // Добавление нового раздела (плюс в заголовке колонки)
            if (e.target.closest('.add-section-icon')) {
                e.preventDefault();
                const taskBlock = e.target.closest('.task-block');
                if (!taskBlock) return;
                const columnContent = taskBlock.querySelector('.column-content');
                const iconClass = taskBlock.classList.contains('contract') ? 'fa-file-signature' : 'fa-bolt';
                handleAddSection(columnContent, iconClass);
                return;
            }

            // Удаление задачи
            const deleteBtn = e.target.closest('.delete-task');
            if (deleteBtn) {
                e.preventDefault();
                const li = deleteBtn.closest('li');
                if (li) handleDelete(li);
                return;
            }

            // Переключение метки hight
            const markHight = e.target.closest('.mark-hight');
            if (markHight) {
                e.preventDefault();
                const li = markHight.closest('li');
                if (li) toggleHight(li);
                return;
            }

            // Переключение метки low
            const markLow = e.target.closest('.mark-low');
            if (markLow) {
                e.preventDefault();
                const li = markLow.closest('li');
                if (li) toggleLow(li);
                return;
            }

            // Добавление задачи
            const addBtn = e.target.closest('.add-task-form button');
            if (addBtn) {
                e.preventDefault();
                const form = addBtn.closest('.add-task-form');
                const input = form.querySelector('input');
                const list = form.nextElementSibling;
                if (list && list.classList.contains('task-list')) {
                    handleAdd(input, addBtn, list);
                }
                return;
            }
        });

        // ---------- НАВИГАЦИЯ ----------
        function initNav() {
            document.querySelectorAll('.nav a').forEach(link => {
                link.addEventListener('click', function(e) {
                    if (this.id === 'resetBtn' || this.id === 'saveBtn') return;
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    const target = document.querySelector(targetId);
                    if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // ---------- СБРОС ----------
        document.getElementById('resetBtn').addEventListener('click', function() {
            localStorage.removeItem(STORAGE_KEY);
            const app = document.getElementById('app');
            app.innerHTML = buildApp();
            afterLoad();
        });

        // ---------- СОХРАНЕНИЕ В HTML ----------
        function saveAsHTML() {
            const html = document.documentElement.outerHTML;
            const startMarker = '// ===СКРИПТ_НАЧАЛО===';
            const endMarker = '// ===СКРИПТ_КОНЕЦ===';

            const startIdx = html.indexOf(startMarker);
            const endIdx = html.indexOf(endMarker, startIdx);

            if (startIdx === -1 || endIdx === -1) {
                alert('Не удалось найти скрипт для модификации.');
                return;
            }

            const beforeScript = html.substring(0, startIdx);
            const afterScript = html.substring(endIdx + endMarker.length);
            const currentScriptContent = html.substring(startIdx + startMarker.length, endIdx);

            const newScriptContent = currentScriptContent.replace(
                /(const app = document\.getElementById\('app'\);)([\s\S]*?)(afterLoad\(\);)/,
                `$1
        // Если в #app уже есть дети (сохранённая версия), не перестраиваем
        if (app.children.length === 0) {
            app.innerHTML = buildApp();
            loadFromLocalStorage();
        }
        $3`
            );

            const newHtml = beforeScript + startMarker + newScriptContent + endMarker + afterScript;
            const blob = new Blob([newHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ife_roadmap_edited.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.getElementById('saveBtn').addEventListener('click', saveAsHTML);

        function afterLoad() {
            initSortable();
            initNav();
        }

        // ---------- ЗАПУСК ----------
        const app = document.getElementById('app');
        app.innerHTML = buildApp();

        if (!loadFromLocalStorage()) {
            // если нет сохранения, оставляем как есть
        }
        afterLoad();

        // ===СКРИПТ_КОНЕЦ===
    })();
</script>
</body>
</html>
